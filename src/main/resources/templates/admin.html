<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard</title>
    <meta charset="UTF-8" />
</head>
<body>

<h1>Admin Dashboard</h1>

<h2>Products</h2>
<div id="productFormModal" style="display:none; position:fixed; top:20%; left:35%; background:#f0f0f0; padding:20px; border:1px solid #ccc; z-index:1000;">
    <h3>Add Product</h3>
    <form id="productForm">
        <label>Name: <input type="text" id="productName" required/> <span style="color:red">*</span></label><br><br>
        <label>Description: <input type="text" id="productDescription" required/><span style="color:red">*</span></label><br><br>
        <label>Price: <input type="number" id="productPrice" required/><span style="color:red">*</span></label><br><br>
        <label>Quantity: <input type="number" id="productQuantity" required/><span style="color:red">*</span></label><br><br>
        <label>Image URL: <input type="text" id="productImageUrl" /></label><br><br>
        <button type="submit" id="submitProductBtn">Submit</button>
        <button type="button" onclick="document.getElementById('productFormModal').style.display='none'">Cancel</button>
    </form>
</div>

<div id="userFormModal" style="display:none; position:fixed; top:20%; left:35%; background:#f0f0f0; padding:20px; border:1px solid #ccc; z-index:1000;">
    <h3>Add User</h3>
    <form id="userForm">
        <label>username: <input type="text" id="username" required/><span style="color:red">*</span></label><br><br>
        <label>email: <input type="text" id="email" required/><span style="color:red">*</span></label><br><br>
        <label>password: <input type="password" id="password" required/><span style="color:red">*</span></label><br><br>
        <label>role:
            <select id="role">
                <option value="ADMIN">Admin</option>
                <option value="USER">User</option>
            </select>
        </label><br><br>
        <button id="submitUserBtn">Submit</button>
        <button onclick="document.getElementById('userFormModal').style.display='none'">Cancel</button>
    </form>
</div>

<table border="1">
    <thead>
    <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Description</th>
        <th>Price</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="product : ${productItems}">
        <td th:text="${product.id}"></td>
        <td th:text="${product.name}"></td>
        <td th:text="${product.description}"></td>
        <td th:text="${product.price}"></td>
        <td>
            <button type="button" id="removeProductBtn" class="removeProduct-btn" th:data-id="${product.id}">Remove</button>
        </td>
    </tr>
    </tbody>
</table>
<button type="button" id="addProductBtn" class="addProduct-btn">Add</button>

<h2>Users</h2>
<table border="1">
    <thead>
    <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Role</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="user : ${users}">
        <td th:text="${user.id}"></td>
        <td th:text="${user.username}"></td>
        <td th:text="${user.role}"></td>
        <td>
            <button type="button" id="removeUserBtn" class="removeUser-btn" th:data-id="${user.id}">Remove</button>
        </td>
    </tr>
    </tbody>
</table>
<button type="button" id="addUserBtn" class="addUser-btn">Add</button><br><br><br>


<div class="logout">
    <button id="logoutBtn" class="btn-logout">Logout</button>
    <button id="productsBtn" class="btn-products" style="margin-left: 10px;">Products</button>
</div>

<script>
    document.getElementById('addProductBtn').addEventListener('click', function () {
        document.getElementById('productFormModal').style.display = 'block';
    });

    document.getElementById('addUserBtn').addEventListener('click', function () {
        document.getElementById('userFormModal').style.display = 'block';
    });

    document.getElementById('productForm').addEventListener('click', function (event) {
        event.preventDefault();
        if (this.checkValidity()) {
            const formData = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                quantity: parseInt(document.getElementById('productQuantity').value),
                imageUrl: document.getElementById('productImageUrl').value
            };

            fetch('/api/products', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert("New product added.");
                        window.location.reload();
                    } else {
                        return response.text().then(text => { throw new Error(text); });
                    }
                })
                .catch(error => {
                    alert(error.message);
                });

            document.getElementById('productFormModal').style.display = 'none';
        }else {
            this.reportValidity();
        }
    });

    document.getElementById('userForm').addEventListener('click', function (event) {
        event.preventDefault();
        if (this.checkValidity()) {
            const formData = {
                username: document.getElementById('username').value,
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                role: document.getElementById('role').value,
            };

            fetch('/api/users/register', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData),
                credentials: 'include'
            })
                .then(response => {
                    if (response.ok) {
                        alert("New User registered successfully.");
                        window.location.reload();

                    } else {
                        return response.text().then(text => { throw new Error(text); });
                    }
                })
                .catch(error => {
                    alert(error.message);
                });

            document.getElementById('productFormModal').style.display = 'none';
        } else {
            this.reportValidity();
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', function () {
        fetch('/api/auth/logout', {
            method: 'POST',
            credentials: 'include'
        })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/index.html';
                } else {
                    return response.text().then(text => { throw new Error(text); });
                }
            })
            .catch(error => {
                alert("Logout failed: " + error.message);
            });
    });

    document.getElementById('productsBtn').addEventListener('click', function () {
        window.location.href = '/products';
    });

    document.querySelectorAll('.removeProduct-btn').forEach(button => {
        button.addEventListener('click', function () {
            const productId = this.getAttribute('data-id');

            fetch(`/api/products/${productId}`, {
                method: "DELETE"
            })
                .then(res => {
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        return res.text().then(msg => alert(msg));
                    }
                })
                .catch(err => alert("Error removing product: " + err.message));
        });
    });

    document.querySelectorAll('.removeUser-btn').forEach(button => {
        button.addEventListener('click', function () {
            const userId = this.getAttribute('data-id');

            fetch(`/api/users/${userId}`, {
                method: "DELETE"
            })
                .then(res => {
                    if (res.ok) {
                        window.location.reload();
                    } else {
                        return res.text().then(msg => alert(msg));
                    }
                })
                .catch(err => alert("Error removing user: " + err.message));
        });
    });

</script>

</body>
</html>
